<!-- Wappler include head-page="layouts/dashboard" fontawesome_5="cdn" bootstrap5="local" is="dmx-app" id="atendimento" appConnect="local" components="{dmxBootstrap5Modal:{},dmxFormatter:{},dmxDataTraversal:{}}" -->


<dmx-data-detail id="data_atendimento" dmx-bind:data="apiTodosAtendimentos.data.queryListaAtendimentos" key="id"></dmx-data-detail>
<dmx-serverconnect id="apiListarNotas" noload="true" url="/api/atendimentos/listar-notas" dmx-param:id=""></dmx-serverconnect>
<dmx-serverconnect id="apiTodosAtendimentos" url="/api/atendimentos/listar-atendimento"></dmx-serverconnect>
<dmx-serverconnect id="apiListarFrequentadores" url="/api/frequentadores/listar-frequentadores"></dmx-serverconnect>
<div class="modal" id="criarModalAtendimento" is="dmx-bs5-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Criar atendimento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" dmx-on:click="criarFormAtendimento.reset()"></button>
            </div>
            <div class="modal-body">
                <form id="form1" is="dmx-serverconnect-form" method="post" action="/api/atendimentos/criar-atendimento" dmx-on:error="form1.reset();criarModalAtendimento.hide();toast.danger('Ocorreu um erro: '+lastError.status+lastError.message+lastError.response)" dmx-on:success="form1.reset();criarModalAtendimento.hide();apiTodosAtendimentos.load({});toast.success('Cadastro realizado com sucesso.')">
                    <div class="form-group mb-3">
                        <input type="hidden" class="form-control" id="criadopor" name="criadopor" aria-describedby="input1_help" placeholder="Enter some text" dmx-bind:value="identificadUsuario.data.queryUsuarioLogado.id">
                    </div>
                    <div class="form-group mb-3">
                        <input type="hidden" class="form-control" id="frequentador" name="frequentador" aria-describedby="input1_help" placeholder="Enter some text" dmx-bind:value="select1.selectedValue">
                    </div>
                    <div class="form-group mb-3"> <label for="input3" class="form-label">Frequentador</label>
                        <select id="select1" class="form-select py-2" dmx-bind:options="apiListarFrequentadores.data.queryFrequentadores" optiontext="_['nome-completo']" optionvalue="id">
                            <option value="null" disabled>Selecione um frequentador</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" dmx-on:click="criarFormAtendimento.reset()">Cancelar</button>
                <button type="button" class="btn btn-primary" dmx-on:click="form1.submit()">Cadastrar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="criarModalNota" is="dmx-bs5-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar nota</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" dmx-on:click="criarFormNota.reset();data_atendimento.select(0)"></button>
            </div>
            <div class="modal-body">
                <form id="criarFormNota" is="dmx-serverconnect-form" method="post" action="/api/atendimentos/notas-atendimento" dmx-on:error="criarFormNota.reset();criarModalNota.hide();data_atendimento.select(0);toast.danger('Ocorreu um erro: '+lastError.status+lastError.message+lastError.response)" dmx-on:success="criarFormNota.reset();apiTodosAtendimentos.load({});apiListarNotas.load({id: data_atendimento.data.id});toast.success('Nota adicionada com sucesso.')">
                    <div class="form-group mb-3">
                        <input type="hidden" class="form-control" id="criadopor" name="criadopor" aria-describedby="input1_help" placeholder="Enter some text" dmx-bind:value="identificadUsuario.data.queryUsuarioLogado.id">
                        <input type="hidden" class="form-control" id="id" name="id" aria-describedby="input1_help" placeholder="Enter some text" dmx-bind:value="data_atendimento.data.id">
                    </div>
                    <div class="form-group mb-3">
                        <textarea id="nota" class="form-control text-nota" name="nota"></textarea>
                    </div>
                </form>
                <div class="container">
                    <div class="row" is="dmx-repeat" id="rpNotas" dmx-bind:repeat="apiListarNotas.data.queryNotas" key="id">
                        <div class="col-12 py-2 border-top">
                            <p class="m-0 mb-2">{{nota}}</p>
                            <h1 class="mini-text"><b>Criado por:</b> {{_['nome-completo']}} - {{_['criado-em']}}</h1>

                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" dmx-on:click="criarFormNota.reset();data_atendimento.select(0)">Cancelar</button>
                <button type="button" class="btn btn-primary" dmx-on:click="criarFormNota.submit()">Adicionar nota</button>
            </div>
        </div>
    </div>
</div>

<main>
    <div class="d-flex flex-row justify-content-between align-items-center p-3 rounded-3 mb-3 bg-body-tertiary">
        <div class="d-flex align-items-center">
            <h4 class="m-0">Atendimento</h4>
        </div><button id="btn1" class="btn btn-dark py-2" data-bs-toggle="modal" data-bs-target="#criarModalAtendimento">Cadastrar</button>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <div class="row" is="dmx-repeat" id="atendimentos" dmx-bind:repeat="apiTodosAtendimentos.data.queryListaAtendimentos" key="id">
                    <div class="col-3">
                        <div class="card">
                            <div class="card-header">Criado em: {{_['criado-em']}}</div>
                            <div class="card-body">

                                <h6 class="card-title mb-3">{{_['nome-completo']}}</h6><button id="btn2" class="btn btn-primary" dmx-on:click="data_atendimento.select(id);apiListarNotas.load({id: id})" data-bs-toggle="modal" data-bs-target="#criarModalNota">Adicionar nota</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</main>
<meta name="ac:route" content="/d/atendimento">